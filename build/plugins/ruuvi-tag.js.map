{
  "version": 3,
  "sources": ["../../src/plugins/ruuvi-tag.ts"],
  "sourcesContent": ["/*!\n * Plugin for ruuvi tags with support for the protocol versions 2-5.\n * See https://github.com/ruuvi/ruuvi-sensor-protocols for details\n */\n\nimport * as nodeUrl from \"url\";\nimport { Global as _ } from \"../lib/global\";\nimport type { PeripheralInfo } from \"../lib/scanProcessInterface\";\nimport {\n\tparseDataFormat2or4,\n\tparseDataFormat3,\n\tparseDataFormat5,\n\tRuuviContext,\n} from \"./lib/ruuvi-tag_protocol\";\nimport {\n\tDeviceObjectDefinition,\n\tgetServiceData,\n\tPlugin,\n\tStateObjectDefinition,\n} from \"./plugin\";\n\nconst serviceUUID = \"feaa\";\nconst manufacturerId = Buffer.from([0x99, 0x04]);\n\n// remember tested peripherals by their ID for 1h\nconst testValidity = 1000 * 3600;\nconst testedPeripherals = new Map<\n\tstring,\n\t{ timestamp: number; result: boolean }\n>();\n\nconst plugin: Plugin<RuuviContext> = {\n\tname: \"ruuvi-tag\",\n\tdescription: \"Ruuvi Tag\",\n\n\tadvertisedServices: [serviceUUID],\n\n\tisHandling: (peripheral: PeripheralInfo) => {\n\t\tconst cached = testedPeripherals.get(peripheral.id);\n\t\tif (cached && cached.timestamp >= Date.now() - testValidity) {\n\t\t\t// we have a recent test result, return it\n\t\t\treturn cached.result;\n\t\t}\n\t\t// we have no quick check, so try to create a context\n\t\tlet ret = false;\n\t\ttry {\n\t\t\tconst ctx = plugin.createContext(peripheral);\n\t\t\tret = ctx != null;\n\t\t} catch (e) {\n\t\t\t/* all good */\n\t\t}\n\t\t// store the test result\n\t\ttestedPeripherals.set(peripheral.id, {\n\t\t\ttimestamp: Date.now(),\n\t\t\tresult: ret,\n\t\t});\n\t\treturn ret;\n\t},\n\n\tcreateContext: (peripheral: PeripheralInfo) => {\n\t\tif (!peripheral.advertisement) return;\n\t\tlet data = getServiceData(peripheral, serviceUUID);\n\t\tif (data != undefined) {\n\t\t\tconst url = data.toString(\"utf8\");\n\t\t\t_.adapter.log.debug(\n\t\t\t\t`ruuvi-tag >> got url: ${data.toString(\"utf8\")}`,\n\t\t\t);\n\t\t\t// data format 2 or 4 - extract from URL hash\n\t\t\tconst parsedUrl = nodeUrl.parse(url);\n\t\t\tif (!parsedUrl.hash) return;\n\t\t\tdata = Buffer.from(parsedUrl.hash, \"base64\");\n\t\t\treturn parseDataFormat2or4(data);\n\t\t} else if (\n\t\t\tperipheral.advertisement.manufacturerData != null &&\n\t\t\tperipheral.advertisement.manufacturerData.length > 0\n\t\t) {\n\t\t\t// When the data is decoded from manufacturerData, the first two bytes should be 0x9904\n\t\t\tdata = peripheral.advertisement.manufacturerData;\n\t\t\tif (data.length <= 2 || !data.slice(0, 2).equals(manufacturerId)) {\n\t\t\t\t_.adapter.log.debug(\n\t\t\t\t\t`ruuvi-tag >> got unsupported data: ${data.toString(\n\t\t\t\t\t\t\"hex\",\n\t\t\t\t\t)}`,\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// Cut off the manufuacturer ID\n\t\t\tdata = data.slice(2);\n\t\t\t// data format 3 or 5 - extract from manufacturerData buffer\n\t\t\t_.adapter.log.debug(\n\t\t\t\t`ruuvi-tag >> got data: ${data.toString(\"hex\")}`,\n\t\t\t);\n\t\t\tif (data[0] === 3) {\n\t\t\t\treturn parseDataFormat3(data);\n\t\t\t} else if (data[0] === 5) {\n\t\t\t\treturn parseDataFormat5(data);\n\t\t\t} else {\n\t\t\t\t_.adapter.log.debug(\n\t\t\t\t\t`ruuvi-tag >> unsupported data format ${data[0]}`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t},\n\n\tdefineObjects: (context) => {\n\t\tif (context == undefined) return;\n\n\t\tconst deviceObject: DeviceObjectDefinition = {\n\t\t\t// no special definitions neccessary\n\t\t\tcommon: {\n\t\t\t\tname: \"Ruuvi Tag\",\n\t\t\t},\n\t\t\tnative: undefined,\n\t\t};\n\t\tif (\"beaconID\" in context) {\n\t\t\tdeviceObject.native = { beaconID: context.beaconID } as any;\n\t\t}\n\n\t\t// no channels\n\n\t\tconst stateObjects: StateObjectDefinition[] = [];\n\n\t\tconst ret = {\n\t\t\tdevice: deviceObject,\n\t\t\tchannels: undefined,\n\t\t\tstates: stateObjects,\n\t\t};\n\n\t\tif (\"temperature\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"temperature\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"Temperature\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tunit: \"\u00B0C\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\t\tif (\"humidity\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"humidity\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"Relative Humidity\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tunit: \"%rF\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\t\tif (\"pressure\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"pressure\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"Air pressure\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tunit: \"hPa\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\t\tif (context.acceleration != undefined) {\n\t\t\tif (context.acceleration.x != null) {\n\t\t\t\tstateObjects.push({\n\t\t\t\t\tid: \"accelerationX\",\n\t\t\t\t\tcommon: {\n\t\t\t\t\t\trole: \"value\",\n\t\t\t\t\t\tname: \"Acceleration (X)\",\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tunit: \"G\",\n\t\t\t\t\t\tread: true,\n\t\t\t\t\t\twrite: false,\n\t\t\t\t\t},\n\t\t\t\t\tnative: undefined,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (context.acceleration.y != null) {\n\t\t\t\tstateObjects.push({\n\t\t\t\t\tid: \"accelerationY\",\n\t\t\t\t\tcommon: {\n\t\t\t\t\t\trole: \"value\",\n\t\t\t\t\t\tname: \"Acceleration (Y)\",\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tunit: \"G\",\n\t\t\t\t\t\tread: true,\n\t\t\t\t\t\twrite: false,\n\t\t\t\t\t},\n\t\t\t\t\tnative: undefined,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (context.acceleration.z != null) {\n\t\t\t\tstateObjects.push({\n\t\t\t\t\tid: \"accelerationZ\",\n\t\t\t\t\tcommon: {\n\t\t\t\t\t\trole: \"value\",\n\t\t\t\t\t\tname: \"Acceleration (Z)\",\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tunit: \"G\",\n\t\t\t\t\t\tread: true,\n\t\t\t\t\t\twrite: false,\n\t\t\t\t\t},\n\t\t\t\t\tnative: undefined,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tif (\"battery\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"battery\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"Battery\",\n\t\t\t\t\tdesc: \"Battery voltage\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tunit: \"mV\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\t\tif (\"txPower\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"txPower\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"TX Power\",\n\t\t\t\t\tdesc: \"Transmit power\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tunit: \"dBm\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\t\tif (\"movementCounter\" in context) {\n\t\t\tstateObjects.push({\n\t\t\t\tid: \"movementCounter\",\n\t\t\t\tcommon: {\n\t\t\t\t\trole: \"value\",\n\t\t\t\t\tname: \"Movement counter\",\n\t\t\t\t\tdesc: \"Incremented through motion detection interrupts\",\n\t\t\t\t\ttype: \"number\",\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: false,\n\t\t\t\t},\n\t\t\t\tnative: undefined,\n\t\t\t});\n\t\t}\n\n\t\treturn ret;\n\t},\n\tgetValues: (context) => {\n\t\tif (context == null) return;\n\n\t\t// strip out unnecessary properties\n\t\tconst {\n\t\t\tdataFormat,\n\t\t\tbeaconID,\n\t\t\tmacAddress,\n\t\t\tsequenceNumber,\n\t\t\t...remainder\n\t\t} = context;\n\t\t// if acceleration exists, we need to rename the acceleration components\n\t\tconst { acceleration, ...ret } = remainder;\n\t\tif (acceleration != null) {\n\t\t\tconst { x, y, z } = acceleration;\n\t\t\tif (x != null) (ret as any).accelerationX = x;\n\t\t\tif (y != null) (ret as any).accelerationY = y;\n\t\t\tif (z != null) (ret as any).accelerationZ = z;\n\t\t}\n\t\treturn ret;\n\t},\n};\n\nexport = plugin as Plugin;\n"],
  "mappings": "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",
  "names": []
}
