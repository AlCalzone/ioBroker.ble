{
  "version": 3,
  "sources": ["../../../src/plugins/lib/xiaomi_protocol.ts"],
  "sourcesContent": ["const enum FrameControlFlags {\n\tNewFactory = 1 << 0,\n\tConnected = 1 << 1,\n\tCentral = 1 << 2,\n\tEncrypted = 1 << 3,\n\tMacAddress = 1 << 4,\n\tCapabilities = 1 << 5,\n\tEvent = 1 << 6,\n\tCustomData = 1 << 7,\n\tSubtitle = 1 << 8,\n\tBinding = 1 << 9,\n}\n\nexport enum CapabilityFlags {\n\tConnectable = 1 << 0,\n\tCentral = 1 << 1,\n\tEncrypt = 1 << 2,\n\tIO = (1 << 3) | (1 << 4),\n}\n\nexport enum XiaomiEventIDs_Internal {\n\tTemperature = 0x1004, // temp = value / 10\n\tKettleStatusAndTemperature = 0x1005, // 1 byte status, 1 byte temperature\n\tHumidity = 0x1006, // humidity = value / 10\n\tIlluminance = 0x1007,\n\tMoisture = 0x1008,\n\tFertility = 0x1009,\n\tBattery = 0x100a,\n\tTemperatureAndHumidity = 0x100d, // 2 byte temperature / 10, 2 byte humidity / 10\n}\n\nexport type XiaomiEventIDs =\n\t| \"temperature\"\n\t| \"humidity\"\n\t| \"illuminance\"\n\t| \"moisture\"\n\t| \"fertility\"\n\t| \"battery\"\n\t| \"kettleStatus\";\n\nexport type XiaomiEvent = Partial<Record<XiaomiEventIDs, number>>;\ntype ValueTransform = (\n\tval: number,\n\teventID?: XiaomiEventIDs_Internal,\n) => XiaomiEvent;\n\n// value transforms translate the internal data structure to the external one\n// in most cases this is a 1:1 match\nconst valueTransforms: Partial<\n\tRecord<keyof typeof XiaomiEventIDs_Internal, ValueTransform>\n> & { default: ValueTransform } = {\n\t// by default just pass the value through\n\tdefault: (val, eventID) => {\n\t\tif (eventID! in XiaomiEventIDs_Internal) {\n\t\t\treturn { [XiaomiEventIDs_Internal[eventID!].toLowerCase()]: val };\n\t\t} else {\n\t\t\treturn { [`unknown (0x${eventID!.toString(16)})`]: val };\n\t\t}\n\t},\n\t// TODO: find a nicer way to specify the bit size of temperature - this information exists in the packet!\n\tTemperature: (val) => ({ temperature: toSigned(val, 16) / 10 }),\n\tHumidity: (val) => ({ humidity: val / 10 }),\n\tTemperatureAndHumidity: (val) => ({\n\t\t// the data is read in little-endian (reverse) order,\n\t\t// so val = 0xHHHHTTTT\n\t\thumidity: (val >>> 16) / 10,\n\t\ttemperature: toSigned(val & 0xffff, 16) / 10,\n\t}),\n\tKettleStatusAndTemperature: (val) => ({\n\t\t// the data is read in little-endian (reverse) order, so val = 0xTTSS\n\t\tkettleStatus: val & 0xff,\n\t\ttemperature: val >>> 8,\n\t}),\n};\n\nexport class XiaomiAdvertisement {\n\tpublic constructor(data: Buffer) {\n\t\tif (!data || data.length < 5) {\n\t\t\tthrow new Error(\n\t\t\t\t\"A xiaomi advertisement frame must be at least 5 bytes long\",\n\t\t\t);\n\t\t}\n\t\t// 4 bit version, 12 bit flags\n\t\tconst frameControl = data.readUInt16LE(0);\n\t\tthis._version = frameControl >>> 12;\n\t\tconst flags = frameControl & 0xfff;\n\t\tthis._isNewFactory = (flags & FrameControlFlags.NewFactory) !== 0;\n\t\tthis._isConnected = (flags & FrameControlFlags.Connected) !== 0;\n\t\tthis._isCentral = (flags & FrameControlFlags.Central) !== 0;\n\t\tthis._isEncrypted = (flags & FrameControlFlags.Encrypted) !== 0;\n\t\tthis._hasMacAddress = (flags & FrameControlFlags.MacAddress) !== 0;\n\t\tthis._hasCapabilities = (flags & FrameControlFlags.Capabilities) !== 0;\n\t\tthis._hasEvent = (flags & FrameControlFlags.Event) !== 0;\n\t\tthis._hasCustomData = (flags & FrameControlFlags.CustomData) !== 0;\n\t\tthis._hasSubtitle = (flags & FrameControlFlags.Subtitle) !== 0;\n\t\tthis._isBindingFrame = (flags & FrameControlFlags.Binding) !== 0;\n\n\t\tthis._productID = data.readUInt16LE(2);\n\n\t\tthis._frameCounter = data[4];\n\n\t\t// Avoid creating thousands of unknown(0xabcd) states\n\t\tif (this._isEncrypted) {\n\t\t\tthrow new Error(\"Encrypted advertisements are not supported\");\n\t\t}\n\n\t\t// The actual packet content begins at offset 5\n\t\tlet offset = 5;\n\t\tif (this._hasMacAddress) {\n\t\t\tthis._macAddress = reverseBuffer(\n\t\t\t\tdata.slice(offset, offset + 6),\n\t\t\t).toString(\"hex\");\n\t\t\toffset += 6;\n\t\t}\n\n\t\tif (this._hasCapabilities) {\n\t\t\tthis._capabilities = data[offset];\n\t\t\toffset++;\n\t\t}\n\n\t\tif (this._hasEvent) {\n\t\t\tconst eventID = data.readUInt16LE(offset);\n\t\t\t// const eventName = XiaomiEventIDs_Internal[\n\t\t\t// \teventID\n\t\t\t// ] as keyof typeof XiaomiEventIDs_Internal;\n\t\t\tconst dataLength = data[offset + 2];\n\t\t\tconst eventData = data.slice(offset + 3, offset + 3 + dataLength);\n\t\t\tconst numericData = parseNumberLE(eventData);\n\t\t\t// check if there's a specialized value transform\n\t\t\tif (XiaomiEventIDs_Internal[eventID] in valueTransforms) {\n\t\t\t\tthis._event = (valueTransforms as any)[\n\t\t\t\t\tXiaomiEventIDs_Internal[eventID]\n\t\t\t\t](numericData);\n\t\t\t} else {\n\t\t\t\tthis._event = valueTransforms.default(numericData, eventID);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _productID: number;\n\tpublic get productID(): number {\n\t\treturn this._productID;\n\t}\n\n\tprivate _version: number;\n\tpublic get version(): number {\n\t\treturn this._version;\n\t}\n\n\tprivate _frameCounter: number;\n\tpublic get frameCounter(): number {\n\t\treturn this._frameCounter;\n\t}\n\n\tprivate _isNewFactory: boolean;\n\tpublic get isNewFactory(): boolean {\n\t\treturn this._isNewFactory;\n\t}\n\n\tprivate _isConnected: boolean;\n\tpublic get isConnected(): boolean {\n\t\treturn this._isConnected;\n\t}\n\n\tprivate _isCentral: boolean;\n\tpublic get isCentral(): boolean {\n\t\treturn this._isCentral;\n\t}\n\n\tprivate _isEncrypted: boolean;\n\tpublic get isEncrypted(): boolean {\n\t\treturn this._isEncrypted;\n\t}\n\n\tprivate _hasMacAddress: boolean;\n\tpublic get hasMacAddress(): boolean {\n\t\treturn this._hasMacAddress;\n\t}\n\n\tprivate _macAddress: string | undefined;\n\tpublic get macAddress(): string | undefined {\n\t\treturn this._macAddress;\n\t}\n\n\tprivate _hasCapabilities: boolean;\n\tpublic get hasCapabilities(): boolean {\n\t\treturn this._hasCapabilities;\n\t}\n\n\tprivate _capabilities: number | undefined;\n\tpublic get capabilities(): number | undefined {\n\t\treturn this._capabilities;\n\t}\n\n\tprivate _hasEvent: boolean;\n\tpublic get hasEvent(): boolean {\n\t\treturn this._hasEvent;\n\t}\n\n\tprivate _event: XiaomiEvent | undefined;\n\tpublic get event(): XiaomiEvent | undefined {\n\t\treturn this._event;\n\t}\n\n\tprivate _hasCustomData: boolean;\n\tpublic get hasCustomData(): boolean {\n\t\treturn this._hasCustomData;\n\t}\n\n\tprivate _customData: Buffer | undefined;\n\tpublic get customData(): Buffer | undefined {\n\t\treturn this._customData;\n\t}\n\n\tprivate _hasSubtitle: boolean;\n\tpublic get hasSubtitle(): boolean {\n\t\treturn this._hasSubtitle;\n\t}\n\n\tprivate _isBindingFrame: boolean;\n\tpublic get isBindingFrame(): boolean {\n\t\treturn this._isBindingFrame;\n\t}\n}\n\nfunction reverseBuffer(buf: Buffer): Buffer {\n\tconst ret = Buffer.allocUnsafe(buf.length);\n\tfor (let i = 0; i < buf.length; i++) {\n\t\tret[i] = buf[buf.length - 1 - i];\n\t}\n\treturn ret;\n}\n\nfunction parseNumberLE(\n\tbuf: Buffer,\n\toffset: number = 0,\n\tlength: number = buf.length,\n): number {\n\t// read <length> bytes in LE order\n\tlet value = 0;\n\tfor (let i = offset + length - 1; i >= offset; i--) {\n\t\tvalue = (value << 8) + buf[i];\n\t}\n\treturn value;\n}\n\n/** Converts an unsigned number to a signed one (e.g. 0xffff = 65535 -> -1) */\nfunction toSigned(unsigned: number, size: number): number {\n\tif (unsigned >>> (size - 1) === 1) {\n\t\t// if the first bit is 1, we have a negative number\n\t\treturn unsigned - (1 << size);\n\t} else {\n\t\treturn unsigned;\n\t}\n}\n"],
  "mappings": "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",
  "names": ["FrameControlFlags", "CapabilityFlags", "XiaomiEventIDs_Internal"]
}
